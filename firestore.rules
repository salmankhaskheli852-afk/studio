/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model where all user-specific data is private and can only be accessed by the authenticated owner. Global configuration data (like investment plans) is public to read but write-protected. Admins have special privileges to read all user data.
 * Data Structure: All user data is nested under /users/{userId}, including their profile, wallet, and transactions. This path-based nesting is the primary security mechanism. Public data, such as /investment_plans and /admin_wallet_details, exists at the root level.
 * Key Security Decisions:
 *   - Users are strictly isolated and cannot read or write any data outside their own /users/{userId} document tree.
 *   - Admins (identified by custom claims `role`) can read user data and manage transactions based on their level.
 *   - Listing users from the root /users collection is restricted to admins only for security and privacy.
 *   - Collections like `investment_plans` and `admin_wallet_details` are publicly readable to allow the client app to function, but all write operations are restricted to Pro Admins.
 * Denormalization for Authorization: The rules rely on the path structure `/users/{userId}/...` for authorization, which avoids costly `get()` calls to check ownership on nested documents like wallets or transactions. On document creation, the rules validate that internal IDs (e.g., a `userId` field) match the document's path to ensure relational integrity.
 * Structural Segregation: User-private data (`/users/{userId/...}`) is kept in a separate hierarchy from globally-public data (`/investment_plans`), which simplifies security and makes list operations safe and performant.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for reusable logic
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isProAdmin() {
      return isSignedIn() && (request.auth.token.role == "proAdmin" || request.auth.token.email == "salmankhaskheli885@gmail.com");
    }

    function isLocalAdmin() {
      return isSignedIn() && request.auth.token.role == "localAdmin";
    }
    
    function isAdmin() {
      return isProAdmin() || isLocalAdmin();
    }
    
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Manages user profile documents. Users can create and manage their own profile. Pro Admins can read/update all profiles.
     * @path /users/{userId}
     * @principle Enforces self-management for users and full control for Pro Admins. User listing is restricted.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isProAdmin();
    }

    /**
     * @description Secures a user's wallet documents. A user has full control over their own wallets. Admins can read and update wallets for transaction approvals.
     * @path /users/{userId}/wallet/{walletId}
     * @principle Restricts access to a user's own data tree using path-based ownership, with an exception for admin access.
     */
    match /users/{userId}/wallet/{walletId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isOwner(userId);
    }

    /**
     * @description Secures a user's transaction history. Admins can view this history and update status.
     * @path /users/{userId}/wallet/{walletId}/transactions/{transactionId}
     * @principle Inherits ownership from the path, ensuring only the user can manage their financial records. Admins have read and status update access.
     */
    match /users/{userId}/wallet/{walletId}/transactions/{transactionId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId) && request.resource.data.walletId == userId;
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows admins to query across all transaction subcollections.
     * @path /users/{userId}/wallet/{walletId}/transactions/{transactionId}
     * @principle Enables admins to fetch all pending requests efficiently.
     */
     match /{path=**}/transactions/{transactionId} {
       allow get: if isAdmin();
       allow list: if isAdmin();
     }
    
    /**
     * @description Manages investment plan categories.
     * @path /investment_categories/{categoryId}
     * @principle Public Read with Pro Admin-Only Writes.
     */
    match /investment_categories/{categoryId} {
        allow get: if true;
        allow list: if true;
        allow create: if isProAdmin();
        allow update: if isProAdmin();
        allow delete: if isProAdmin();
    }

    /**
     * @description Manages investment plans, which are public to all users for reading.
     * @path /investment_plans/{investmentPlanId}
     * @principle Public Read with Pro Admin-Only Writes.
     */
    match /investment_plans/{investmentPlanId} {
      allow get: if true;
      allow list: if true;
      allow create: if isProAdmin();
      allow update: if isProAdmin();
      allow delete: if isProAdmin();
    }

    /**
     * @description Manages admin wallet details for user deposits. This data is public for viewing.
     * @path /admin_wallet_details/{adminWalletDetailId}
     * @principle Public Read with Pro Admin-Only Writes.
     */
    match /admin_wallet_details/{adminWalletDetailId} {
      allow get: if true;
      allow list: if true;
      allow create: if isProAdmin();
      allow update: if isProAdmin();
      allow delete: if isProAdmin();
    }

    /**
     * @description Manages global application settings like transaction limits.
     * @path /app_settings/{settingsId}
     * @principle Public read for client-side rules, Pro Admin-only write for configuration.
     */
    match /app_settings/{settingsId} {
        allow get: if true;
        allow list: if true;
        allow create: if isProAdmin();
        allow update: if isProAdmin();
        allow delete: if isProAdmin();
    }
  }
}
